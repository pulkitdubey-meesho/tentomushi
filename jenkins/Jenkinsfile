pipeline {
    agent any

    environment {
        IMAGE_NAME = "localhost:5000/tentomushi-frontend"
        DEPLOY_REPO = "https://github.com/pulkitdubey-meesho/tentomushi-deploy.git"
        BRANCH = "main"
    }

    stages {
        stage('Install Docker') {
            steps {
                script {
                    // Check if Docker is installed, if not install it
                    sh '''
                    if ! command -v docker &> /dev/null; then
                        echo "Docker not found, installing..."
                        
                        # Check if we're running as root
                        if [ "$(id -u)" = "0" ]; then
                            echo "Running as root, installing Docker..."
                            SUDO_CMD=""
                        elif command -v sudo &> /dev/null; then
                            echo "Running as non-root with sudo available"
                            SUDO_CMD="sudo"
                        else
                            echo "Running as non-root without sudo, trying direct commands..."
                            SUDO_CMD=""
                        fi
                        
                        # Update package index
                        $SUDO_CMD apt-get update
                        
                        # Install packages to allow apt to use a repository over HTTPS
                        $SUDO_CMD apt-get install -y \
                            apt-transport-https \
                            ca-certificates \
                            curl \
                            gnupg \
                            lsb-release
                        
                        # Add Docker's official GPG key
                        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | $SUDO_CMD gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
                        
                        # Set up the stable repository
                        echo \
                          "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
                          $(lsb_release -cs) stable" | $SUDO_CMD tee /etc/apt/sources.list.d/docker.list > /dev/null
                        
                        # Install Docker Engine
                        $SUDO_CMD apt-get update
                        $SUDO_CMD apt-get install -y docker-ce docker-ce-cli containerd.io
                        
                        # Add jenkins user to docker group (if running as jenkins user and not root)
                        if [ "$(id -u)" != "0" ]; then
                            $SUDO_CMD usermod -aG docker $USER || true
                        fi
                        
                        # Start and enable Docker service
                        $SUDO_CMD systemctl start docker || $SUDO_CMD service docker start || true
                        $SUDO_CMD systemctl enable docker || true
                        
                        echo "Docker installed successfully"
                    else
                        echo "Docker is already installed"
                        docker --version
                    fi
                    '''
                }
            }
        }
        
        stage('Checkout') {
            steps {
                git url: 'https://github.com/pulkitdubey-meesho/tentomushi.git', branch: "${BRANCH}"
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    // Ensure Docker daemon is accessible
                    sh '''
                    # Test Docker access
                    docker --version
                    
                    # Determine if we need sudo for Docker commands
                    if [ "$(id -u)" = "0" ]; then
                        echo "Running as root, using Docker directly"
                        DOCKER_CMD="docker"
                    elif docker ps &> /dev/null; then
                        echo "Docker accessible without sudo"
                        DOCKER_CMD="docker"
                    elif command -v sudo &> /dev/null; then
                        echo "Using sudo for Docker commands"
                        DOCKER_CMD="sudo docker"
                    else
                        echo "No sudo available, trying Docker directly"
                        DOCKER_CMD="docker"
                    fi
                    
                    # Test Docker access
                    $DOCKER_CMD info || echo "Docker daemon may not be accessible"
                    
                    # Build the image
                    $DOCKER_CMD build -t ${IMAGE_NAME}:${BUILD_NUMBER} .
                    '''
                }
            }
        }

        stage('Push to Local Registry') {
            steps {
                script {
                    sh '''
                    # Determine if we need sudo for Docker commands
                    if [ "$(id -u)" = "0" ]; then
                        echo "Running as root, using Docker directly"
                        DOCKER_CMD="docker"
                    elif docker ps &> /dev/null; then
                        echo "Docker accessible without sudo"
                        DOCKER_CMD="docker"
                    elif command -v sudo &> /dev/null; then
                        echo "Using sudo for Docker push..."
                        DOCKER_CMD="sudo docker"
                    else
                        echo "No sudo available, trying Docker directly"
                        DOCKER_CMD="docker"
                    fi
                    
                    # Push the image
                    $DOCKER_CMD push ${IMAGE_NAME}:${BUILD_NUMBER}
                    '''
                }
            }
        }

        stage('Update Manifests Repo') {
            steps {
                sshagent(['ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIYnfiifmrwtI2yM9PZZuvISxlnfu7K5dDq6SlyJEFxi pulkit.dubey@meesho.com']) {
                    sh '''
                    git clone ${DEPLOY_REPO}
                    cd tentomushi-deploy
                    sed -i "s|image: .*|image: ${IMAGE_NAME}:${BUILD_NUMBER}|" manifests/deployment.yaml
                    git config user.name "Jenkins"
                    git config user.email "jenkins@localhost"
                    git commit -am "Update image to ${IMAGE_NAME}:${BUILD_NUMBER}"
                    git push
                    '''
                }
            }
        }
    }
}
